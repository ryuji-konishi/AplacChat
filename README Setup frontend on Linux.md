# Setup Front-End on Linux
This document describes how to setup and run the APLaC Chat front-end web page. This web page accepts the text that the user types in, sends the text to the Chat component and shows the result.

## Setup Environment (MacOS X + .NET Core 2.0 + Linux)
The front-end web page is develped with .NET Core 2.0 and MacOS X is used as the development machine. And finally it will be deployed on a Linux (Red Hat) web hosting server.

### Things required in advance
* .NET Core 2.0 SDK for Mac
* Visual Studio Code for Mac

### Application Configuration
You need different configuration whether you are debugging locally or the package is deployed on producion. In APLaC Chat front-end, it is done by environment variables.

There are following environment variables that are specific to APLaC Chat front-end application.
* CHAT_EMBED_URL - The URL which points to the chat frame page that is designed to be embedded into the parent page using iframe HTML tag.
* CHAT_INFER_URL - The URL which plays a role of APLaC Chat inference API. This URL receives POST requests with text, and returns the resulted text which is the result of NMT Inference.

The above environment variables are set by Visual Studio Code when you debug locally, and set in command terminal when it goes on production.

## Visual Studio Code Configuration
In this project we use Visual Studio Code for debugging. During the debug session the environment variables are set by VSC and those values are stored in `.vscode/launch.json` file. This file is not included in the git repository so you need to add it your self. Usually it is auto-generated by VSC when you open the project folder and start debug session. 
To set the environment variables, add values in the `env` element like below.
```
  "env": {
    "ASPNETCORE_ENVIRONMENT": "Development",
    "ASPNETCORE_URLS": "http://localhost:5051",
    "CHAT_EMBED_URL": "http://localhost:5051/Embed/Index",
    "CHAT_INFER_URL": "http://localhost:5000/infer"
  },
```

### URL Port Number when you debug locally
During your debug session, if you use a single development machine usually the front-end web page and the chat inference run on the same machine. In this case they must have a different port number appended to the local address. This is becaues they are running as a different web server and they will collide if they use the same port. To avoid this, set different port number to `CHAT_EMBED_URL` and `CHAT_INFER_URL`. Also `ASPNETCORE_URLS` should share the same port number with `CHAT_EMBED_URL` because they both refer to the front-end web pages.

### Launch URL when you start debug session
The launch URL for web browsers can also be set in `launchBrowser` element, for Google Chrome
```
  "osx": {
    "command": "open",
    "args": "-a /Applications/\"Google Chrome.app\" --args ${auto-detect-url}"
  },
```

## Build and Deployment
First we generate a publish package with ```dotnet``` command into a self-contained directory that can run on the server.
```
dotnet publish -c Release --self-contained -r linux-x64
```
Refer to [a list of Runtime Identifiers (RIDs)](https://docs.microsoft.com/en-us/dotnet/core/rid-catalog#linux-rids) that is set as the runtime option (-r).
The package folder ```publish``` is generated under bin folder. opy this folder to the server using SCP, FTP, or other file transfer method.


### Reference
https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?tabs=aspnetcore2x

## Development Notes
This section keeps the record of key notes, references and other important points that are found during the development.

### .NET Core Project Generation and Configuration
The original project structure is generated by .NET SDK as Razor Pages Project.
```
dotnet new razor -o frontend
```
Add the bundler minifier NuGet package which is required to generate .min.css and .min.js files. Otherwise those files won't be updated when you build the project.
```
dotnet add package BuildBundlerMinifier
```
Add the Kestrel NuGet package which is required to run on Linux server to serve as a web server.
```
dotnet add package Microsoft.AspNetCore.Server.Kestrel
```
To set the build mode (Release/Debug), set an environment variable below but this is only eligible when you run the project with `dotnet run` command.
```
export ASPNETCORE_ENVIRONMENT=Development
```
Note when you debug the code with Visual Studio Code, the build mode is automatically set to 'Development'.

### Test Run on Windows
.NET Core is cross-platform. You can run frontend on a Windows machine.
#### 1. Install .NET Core SDK 2.0 for Windows
#### 2. Open the console and move to the frontend folder
#### 3. Start local server
Run the following commands.
```
SET CHAT_EMBED_URL=http://aplac-chat.koni4.net/Embed
SET CHAT_INFER_URL=http://<AWS EC2 Instance Domain>/infer
dotnet restore
dotnet run
```
