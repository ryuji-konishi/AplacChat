# Setup Front-End on MacOS
This document describes how to setup and run the APLaC Chat front-end web page locally on your Mac machine.

This front-end web page accepts the text that the user types in, sends the text to the Chat component and shows the result.

## Setup Environment (MacOS X + .NET Core 2.0)
The front-end web page is developed with .NET Core 2.0 + MySQL|SQLite and MacOS is used as the development machine. And finally it will be deployed on a web hosting server but it's not described in this document.

### Things required in advance
* .NET Core 2.0 SDK for Mac
* Visual Studio Code for Mac

### Database Installation
You can choose either MySQL or SQLite for the application database. Here we have the option for SQLite because MySQL(MariaDB) requires middle-high CPU resource and it is too much for AWS EC2 t2.nano instance.

### MySQL
Install MySQL to your Mac by [downloading the installer](https://dev.mysql.com/downloads/mysql/), following the [installation guide](https://dev.mysql.com/doc/mysql-osx-excerpt/5.5/en/osx-installation-pkg.html).
Also get [MySQL Workbench](https://dev.mysql.com/downloads/workbench/.)

During the installation the configurations were all set to default. In the end a dialogue appears with a root username and password.
root@localhost: fxRpOWPx0h?f

MySQL server is now installed, but it is not loaded (started) by default. Use either launchctl from the command line, or start MySQL by clicking "Start" using the MySQL preference pane.

The initial password needs to be changed before you start using MySQL in the application. Open up MySQL Workbench and select the localhost server. Then it will ask for update.

#### Default Character Set
The default character set of MySQL v5.7 is latin1, the collation is latin1_swedish_ci. This causes error when UTF8 is entered. Since we want to store Japanese text and other international languages, we want to make sure 4 byte UTF8 is used. Note 3 byte UTF8, which is pretty much standard in general, is not good to store EMOJIs. So we will set 'utf8mb4' as character set configuration of MySQL.

This workaround is done in Entity Framework Core. Refer to [Text Character Set] section below.

### SQLite
We assume SQLite is preinstalled on your MacOS X. Type the command below to confirm.
```
sqlite3 -version
```

### Application Configuration
Refer to [Environment Variable Settings](README%20Environment%20Variable%20Settings.md] about how to configure APLaC Chat for different running configurations.

## Visual Studio Code Configuration

### URL Port Number when you debug locally
During your debug session, if you use a single development machine usually the front-end web page and the chat inference run on the same machine. In this case they must have a different port number appended to the local address. This is becaues they are running as a different web server and they will collide if they use the same port. To avoid this, set different port number to `CHAT_EMBED_URL` and `CHAT_INFER_URL`. Also `ASPNETCORE_URLS` should share the same port number with `CHAT_EMBED_URL` because they both refer to the front-end web pages.

### Launch URL when you start debug session
The launch URL for web browsers can also be set in `launchBrowser` element, for Google Chrome
```
  "osx": {
    "command": "open",
    "args": "-a /Applications/\"Google Chrome.app\" --args ${auto-detect-url}"
  },
```

## Build and Deployment
It is out of the scope of this document. Refer to [How to setup Chat/Frontend on AWS EC2](frontend/README%20Setup%20chat-frontend%20on%20AWS%20EC2.md).

## Development Notes
This section keeps the record of key notes, references and other important points that are found during the development.

### .NET Core Project Generation and Configuration

#### Project Template
The original project structure is generated by .NET SDK as Razor Pages Project.
```
dotnet new razor -o frontend
```

#### Add Bundler Minifier
Add the bundler minifier NuGet package which is required to generate .min.css and .min.js files. Otherwise those files won't be updated when you build the project.
```
dotnet add package BuildBundlerMinifier
```

#### Add Entity Framework Core
Add Entity Framework Core with data provider of either MySQL or SQLite.
Choose either of below.
```
dotnet add package Pomelo.EntityFrameworkCore.MySql     # for MySQL
dotnet add package Microsoft.EntityFrameworkCore.Sqlite # for SQLite
```
And then run below.
```
dotnet add package Microsoft.EntityFrameworkCore.Tools
dotnet add package Microsoft.EntityFrameworkCore.Design
```
```Microsoft.EntityFrameworkCore.Tools``` is required to use ```dotnet ef``` CLI commands. Type ```dotnet ef -h``` to confirm if successfully setup. If doesn't work, try reopen the terminal.
To use the command in Visual Studio Code integrated terminal, add the following line into frontend.csproj and make sure to run ```dotnet restore```.
```
<ItemGroup>
    <DotNetCliToolReference Include="Microsoft.EntityFrameworkCore.Tools.DotNet" Version="2.0.2" />
</ItemGroup>
```

In ```ApplicationDbContext``` class the following lines configure the database provider. Note the connection string is set as environment variable ```CONNECTION_APPDB```.
```
  protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
  {
      IConfigurationRoot configuration = new ConfigurationBuilder()
          .AddEnvironmentVariables()
          .Build();
      var sqlConnection = configuration.GetSection("CONNECTION_APPDB").Value;
      optionsBuilder.UseMySql(sqlConnection);   // for MySQL
      optionsBuilder.UseSqlite(sqlConnection);  // for SQLite
  }
```

After declaring ApplicationDbContext class, run EF commands for migrations. The initial creation of database can be done with the following command which adds a new migration entry named 'CreateDatabase'.
```
dotnet ef migrations add CreateDatabase
```
Enter the following command to execute the migration that updates the database according to the model design. Also it creates database if doesn't exit.
```
dotnet ef database update
```

If the command fails make sure the environment variable is correctly set.

### Text Character Set (MySQL specific)
There is a requirement that MySQL tables can contain text characters in UTF8 codec, primarily for Japanese language. To do this, text columns in MySQL tables have to be set 'utf8mb4' in character set property, and SQL query below shows an example.
```
CREATE TABLE t1
(
    col1 CHAR(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci
)
```
The above ```CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci``` part is required.

We expect data annotation attribute classes in ```MySQL.Data.EntityFrameworkCore``` do this job. However as of Mar.2018 this isn't going well. Version 6.10.6. and 8.0.10-rc are tested but both didn't work.
Instead, it ended up with ```ColumnType``` attribute using fluent API of the original entity framework core. Both workarounds are described below.

#### MySQL.Data.EntityFrameworkCore (failed)
Add MySQL.Data.EntityFrameworkCore package with command below.
```
dotnet add package MySql.Data.EntityFrameworkCore
```
This package is required for detailed data annotations for EF Core.

The MySQL data annotation is for specifying MySQL text character set and collation. ```MySqlCharsetAttribute``` and ```MySqlCollationAttribute``` are related. This time, since we want to focus on Japanese lanagueage and MySQL 'utf8' character set is not enough to contain EMOJIs, 'utf8mb4' is used instead.

The code below add both character set and collation to ```Input``` column of ```ChatRecord``` table.
```
  modelBuilder.Entity<ChatRecord>(b =>
  {
      b.Property(p => p.Input).ForMySQLHasCharset("utf8mb4");
      b.Property(p => p.Input).ForMySQLHasCollation("utf8mb4_general_ci");
  });
```

For more information, [here](https://dev.mysql.com/doc/connector-net/en/connector-net-entityframework-core-charset.html).

#### ColumnType Attribute (success)
Both data type and character set parameters are set together with HasColumnType method as below.
```
  modelBuilder.Entity<ChatRecord>(b =>
  {
      b.Metadata.Relational().TableName = "ChatRecords";
      b.Property(p => p.Input).HasColumnType("text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci");
  });
```
The above code generate SQL query below.
```
CREATE TABLE `ChatRecords` (
    `Id` int NOT NULL AUTO_INCREMENT,
    `Input` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    CONSTRAINT `PK_ChatRecords` PRIMARY KEY (`Id`)
);
```

### User Authentication
The user authentication mechanism is half implemented with .NET Core Identity framework. As of Mar.2018, this user authentication is disabled, and it's left incomplete. You can enable it by reverting the following parts.
* launch.json - SNS OAuth credentials are to be defined. Refer to [Environment Variable Settings](README%20Environment%20Variable%20Settings.md].
* Startup.cs
  * Enable the code that set SNS OAuth credentials
  * Enable the code that set '/Accout/Login' with ConfigureApplicationCookie()
  * Enable the code that set '/Index' to require user authentication with AddRazorPagesOptions()

Currently it's left incomplete. To make it complete, you need to consider:
* HTTP with SSL (HTTPS) - Facebook requires HTTPS connection during authentication.
* Privacy Policy - Facebook requires [Privacy Policy page](https://termsfeed.com/blog/privacy-policy-url-facebook-app/).
* Google and Facebook are tested. Twitter and Microsoft can be added too. The login button picture is only done for Google. Others can do the same too.
* Chat records are to be linked with User. Also the historical chat records are to be populated on page load.

Also notice that there are two ways to include the chat-box in pages. One is done with '_ChatBodyPartial.cshtml', the other is with iframe. The corresponding URLs are, respectively:
* A. /Index
* B. /Embed/Index
If you enable the user authentication, A is the page that the user needs authentication, while B is not.

Currently both of above behave in the exactly same way. But once the user authentication is integrated, A requires saving chat records with user ID. The corresponding class.method is frontend.Pages.IndexModel.OnPostAsync().

### Test Run on Windows
.NET Core is cross-platform. You can run frontend on a Windows machine.
#### 1. Install .NET Core SDK 2.0 for Windows
#### 2. Open the console and move to the frontend folder
#### 3. Start local server
Run the following commands.
```
SET CHAT_EMBED_URL=http://aplac-chat.koni4.net/Embed
SET CHAT_INFER_URL=http://<AWS EC2 Instance Domain>/infer
dotnet restore
dotnet run
```
