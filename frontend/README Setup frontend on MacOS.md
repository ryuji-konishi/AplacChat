# Setup Front-End on MacOS
This document describes how to setup and run the APLaC Chat front-end web page locally on your Mac machine.

This front-end web page accepts the text that the user types in, sends the text to the Chat component and shows the result.

## Setup Environment (MacOS X + .NET Core 2.0)
The front-end web page is developed with .NET Core 2.0 + MySQL and MacOS is used as the development machine. And finally it will be deployed on a web hosting server but it's not described in this document.

### Things required in advance
* .NET Core 2.0 SDK for Mac
* Visual Studio Code for Mac

### MySQL Installation
Install MySQL to your Mac by [downloading the installer](https://dev.mysql.com/downloads/mysql/), following the [installation guide](https://dev.mysql.com/doc/mysql-osx-excerpt/5.5/en/osx-installation-pkg.html).
Also get [MySQL Workbench](https://dev.mysql.com/downloads/workbench/.)

The installation configurations were all set to default. In the end a dialogue appears with a root username and password.
root@localhost: fxRpOWPx0h?f

MySQL server is now installed, but it is not loaded (started) by default. Use either launchctl from the command line, or start MySQL by clicking "Start" using the MySQL preference pane.

The initial password needs to be changed before you start using MySQL in the application. Open up MySQL Workbench and select the localhost server. Then it will ask for update.

### Application Configuration
You need different configuration whether you are debugging locally or the package is deployed on producion. In APLaC Chat front-end, it is done by environment variables.

There are following environment variables that are specific to APLaC Chat front-end application.
* CHAT_EMBED_URL - The URL which points to the chat frame page that is designed to be embedded into the parent page using iframe HTML tag.
* CHAT_INFER_URL - The URL which plays a role of APLaC Chat inference API. This URL receives POST requests with text, and returns the resulted text which is the result of NMT Inference.

The above environment variables are set by Visual Studio Code when you debug locally, and set in command terminal when it goes on production.

## Visual Studio Code Configuration
In this project we use Visual Studio Code for debugging. During the debug session the environment variables are set by VSC and those values are stored in `.vscode/launch.json` file. This file is not included in the git repository so you need to add it your self. Usually it is auto-generated by VSC when you open the project folder and start debug session. 
To set the environment variables, add values in the `env` element like below.
```
  "env": {
    "ASPNETCORE_ENVIRONMENT": "Development",
    "ASPNETCORE_URLS": "http://localhost:5051",
    "CHAT_EMBED_URL": "http://localhost:5051/Embed/Index",
    "CHAT_INFER_URL": "http://localhost:5000/infer"
  },
```

### URL Port Number when you debug locally
During your debug session, if you use a single development machine usually the front-end web page and the chat inference run on the same machine. In this case they must have a different port number appended to the local address. This is becaues they are running as a different web server and they will collide if they use the same port. To avoid this, set different port number to `CHAT_EMBED_URL` and `CHAT_INFER_URL`. Also `ASPNETCORE_URLS` should share the same port number with `CHAT_EMBED_URL` because they both refer to the front-end web pages.

### Launch URL when you start debug session
The launch URL for web browsers can also be set in `launchBrowser` element, for Google Chrome
```
  "osx": {
    "command": "open",
    "args": "-a /Applications/\"Google Chrome.app\" --args ${auto-detect-url}"
  },
```

## Build and Deployment (TBD)
*When you deploy the .NET Core project on Linux server, follow this section. As of Feb.2018, this section is not complete yet and left as a side node.*

First we generate a publish package with ```dotnet``` command into a self-contained directory that can run on the server.
```
dotnet publish -c Release --self-contained -r linux-x64
```
Refer to [a list of Runtime Identifiers (RIDs)](https://docs.microsoft.com/en-us/dotnet/core/rid-catalog#linux-rids) that is set as the runtime option (-r).
The package folder ```publish``` is generated under bin folder. opy this folder to the server using SCP, FTP, or other file transfer method.

### Reference
https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?tabs=aspnetcore2x

## Development Notes
This section keeps the record of key notes, references and other important points that are found during the development.

### .NET Core Project Generation and Configuration

#### Project Template
The original project structure is generated by .NET SDK as Razor Pages Project.
```
dotnet new razor -o frontend
```

#### Add Bundler Minifier
Add the bundler minifier NuGet package which is required to generate .min.css and .min.js files. Otherwise those files won't be updated when you build the project.
```
dotnet add package BuildBundlerMinifier
```

#### Add Entity Framework Core
Add Entity Framework Core with MySQL data provider.
```
dotnet add package Pomelo.EntityFrameworkCore.MySql
dotnet add package Microsoft.EntityFrameworkCore.Tools
dotnet add package Microsoft.EntityFrameworkCore.Design
```
```Microsoft.EntityFrameworkCore.Tools``` is required to use ```dotnet ef``` CLI commands. Type ```dotnet ef -h``` to confirm if successfully setup. If doesn't work, try reopen the terminal.
To use the command in Visual Studio Code integrated terminal, add the following line into frontend.csproj and make sure to run ```dotnet restore```.
```
<ItemGroup>
    <DotNetCliToolReference Include="Microsoft.EntityFrameworkCore.Tools.DotNet" Version="2.0.2" />
</ItemGroup>
```

In ```ApplicationDbContext``` class the following lines configure MySQL as the database provider. Note the connection string is set as environment variable ```MYSQL_CONNECTION_APPDB```.
```
  protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
  {
      IConfigurationRoot configuration = new ConfigurationBuilder()
          .AddEnvironmentVariables()
          .Build();
      var sqlConnection = configuration.GetSection("MYSQL_CONNECTION_APPDB").Value;
      optionsBuilder.UseMySql(sqlConnection);
  }
```

After declaring ApplicationDbContext class, run EF commands for migrations. The initial creation of database can be done with the following command which adds a new migration entry named 'CreateDatabase'.
```
dotnet ef migrations add CreateDatabase
```
Enter the following command to execute the migration that creates a new schema 'aplacchat' in DB if doesn't exist.
```
dotnet ef database update
```

### Test Run on Windows
.NET Core is cross-platform. You can run frontend on a Windows machine.
#### 1. Install .NET Core SDK 2.0 for Windows
#### 2. Open the console and move to the frontend folder
#### 3. Start local server
Run the following commands.
```
SET CHAT_EMBED_URL=http://aplac-chat.koni4.net/Embed
SET CHAT_INFER_URL=http://<AWS EC2 Instance Domain>/infer
dotnet restore
dotnet run
```
